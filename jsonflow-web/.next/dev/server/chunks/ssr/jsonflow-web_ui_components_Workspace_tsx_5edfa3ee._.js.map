{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/Coding/project/json-flow/jsonflow-web/ui/components/Workspace.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useRef, useState } from \"react\";\nimport cytoscape, { type Core } from \"cytoscape\";\nimport { Engine, toCytoscape } from \"@andro.dev/jsonflow-engine\";\nimport { useTheme } from \"@/contexts/ThemeContext\";\nimport EditorInterface from \"@/components/EditorInterface\";\nimport VisualInterface from \"@/components/VisualInterface\";\nimport type { GraphStats, SchemaStatus, SemanticIssue } from \"@/types/ui\";\n\nconst starterJson = `{\n  \"type\": \"flow\",\n  \"layout\": { \"direction\": \"LR\" },\n  \"nodes\": [\n    { \"id\": \"editor\", \"label\": \"Editor Layer\" },\n    { \"id\": \"logic\", \"label\": \"Logic Layer\" },\n    { \"id\": \"parser\", \"label\": \"Parser Layer\" },\n    { \"id\": \"visual\", \"label\": \"Visualization Layer\" },\n    { \"id\": \"layout\", \"label\": \"Layout Layer\" }\n  ],\n  \"edges\": [\n    { \"from\": \"editor\", \"to\": \"logic\", \"label\": \"validate\", \"kind\": \"next\", \"link_type\": \"solid\" },\n    { \"from\": \"logic\", \"to\": \"parser\", \"label\": \"transform\", \"kind\": \"next\", \"link_type\": \"solid\" },\n    { \"from\": \"parser\", \"to\": \"visual\", \"label\": \"render-ready\", \"kind\": \"next\", \"link_type\": \"arrow\" },\n    { \"from\": \"visual\", \"to\": \"layout\", \"label\": \"layout\", \"kind\": \"next\", \"link_type\": \"dash\" }\n  ]\n}`;\n\nconst engine = new Engine();\n\nconst styles: cytoscape.StylesheetCSS[] = [\n  {\n    selector: \"node\",\n    css: {\n      \"background-color\": \"#1b4332\",\n      \"border-color\": \"#081c15\",\n      \"border-width\": 2,\n      color: \"#fefae0\",\n      \"font-size\": \"12px\",\n      \"font-weight\": 600,\n      label: \"data(label)\",\n      \"text-wrap\": \"wrap\",\n      \"text-max-width\": \"140px\",\n      \"text-valign\": \"center\",\n      \"text-halign\": \"center\",\n      width: \"label\",\n      padding: \"10px\",\n      \"shape\": \"round-rectangle\",\n    },\n  },\n  {\n    selector: \"node[shape]\",\n    css: {\n      \"shape\": \"data(shape)\",\n    },\n  },\n  {\n    selector: \"edge\",\n    css: {\n      width: 2,\n      \"curve-style\": \"bezier\",\n      \"line-color\": \"#2d6a4f\",\n      \"target-arrow-color\": \"#2d6a4f\",\n      \"target-arrow-shape\": \"triangle\",\n      label: \"data(label)\",\n      \"font-size\": \"10px\",\n      \"text-rotation\": \"autorotate\",\n      \"text-margin-y\": -8,\n      \"text-background-color\": \"#fefae0\",\n      \"text-background-opacity\": 0.9,\n      \"text-background-padding\": \"2px\",\n    },\n  },\n  {\n    selector: 'edge[link_type = \"dash\"]',\n    css: { \"line-style\": \"dashed\" },\n  },\n  {\n    selector: 'edge[link_type = \"dot\"]',\n    css: { \"line-style\": \"dotted\" },\n  },\n  {\n    selector: 'edge[link_type = \"bold\"]',\n    css: { width: 4 },\n  },\n  {\n    selector: 'edge[link_type = \"double\"]',\n    css: { width: 3 },\n  },\n  {\n    selector: 'edge[link_type = \"open-arrow\"]',\n    css: { \"target-arrow-shape\": \"vee\" },\n  },\n  {\n    selector: 'edge[link_type = \"solid\"]',\n    css: { \"line-style\": \"solid\" },\n  },\n];\n\nconst applyLayoutDirection = (\n  targetCy: Core,\n  direction: \"LR\" | \"RL\" | \"TB\" | \"BT\",\n) => {\n  const nodes = targetCy.nodes();\n  if (nodes.length === 0) {\n    return;\n  }\n\n  const positions = nodes.map((node) => node.position());\n  const xs = positions.map((pos) => pos.x);\n  const ys = positions.map((pos) => pos.y);\n  const minX = Math.min(...xs);\n  const maxX = Math.max(...xs);\n  const minY = Math.min(...ys);\n  const maxY = Math.max(...ys);\n  const width = Math.max(1, maxX - minX);\n  const height = Math.max(1, maxY - minY);\n\n  nodes.positions((node) => {\n    const { x, y } = node.position();\n    const nx = x - minX;\n    const ny = y - minY;\n\n    if (direction === \"BT\") {\n      return { x, y: minY + (height - ny) };\n    }\n\n    if (direction === \"LR\") {\n      return { x: minX + ny, y: minY + (width - nx) };\n    }\n\n    if (direction === \"RL\") {\n      return { x: minX + (height - ny), y: minY + nx };\n    }\n\n    return { x, y };\n  });\n\n  targetCy.fit(undefined, 24);\n};\n\nexport default function Workspace() {\n  const { theme } = useTheme();\n  const [raw, setRaw] = useState(starterJson);\n  const [debouncedRaw, setDebouncedRaw] = useState(starterJson);\n  const [error, setError] = useState<string | null>(null);\n  const [errorType, setErrorType] = useState<\"json\" | \"schema\" | null>(null);\n  const [parsed, setParsed] = useState<\n    | {\n        ok: true;\n        graph: unknown;\n        engineGraph: { nodes: unknown[]; edges: unknown[] };\n        meta: { isCyclic: boolean };\n        semantic: SemanticIssue[];\n      }\n    | { ok: false; error: unknown }\n  >({ ok: false, error: null });\n  const [cy, setCy] = useState<Core | null>(null);\n  const containerRef = useRef<HTMLDivElement | null>(null);\n  const downloadRef = useRef<HTMLAnchorElement | null>(null);\n\n  useEffect(() => {\n    const handle = setTimeout(() => setDebouncedRaw(raw), 250);\n    return () => clearTimeout(handle);\n  }, [raw]);\n\n  useEffect(() => {\n    try {\n      const json = JSON.parse(debouncedRaw);\n      const result = engine.parse(json);\n      if (!result.ok) {\n        const issues = (result.error as { issues?: { path: (string | number)[]; message: string }[] }).issues;\n        if (issues && issues.length > 0) {\n          const first = issues[0];\n          const path = first.path.length > 0 ? first.path.join(\".\") : \"root\";\n          setErrorType(\"schema\");\n          setError(`Schema error at ${path}: ${first.message}`);\n        } else {\n          setErrorType(\"schema\");\n          setError(\"Schema validation failed.\");\n        }\n      } else {\n        setErrorType(null);\n        setError(null);\n      }\n      setParsed(result);\n    } catch (parseError) {\n      const message = parseError instanceof Error ? parseError.message : \"Invalid JSON\";\n      setErrorType(\"json\");\n      setError(`JSON parse error: ${message}`);\n      setParsed({ ok: false, error: parseError });\n    }\n  }, [debouncedRaw]);\n\n  const status: SchemaStatus = parsed.ok ? \"ok\" : \"error\";\n  const stats: GraphStats = parsed.ok\n    ? {\n        nodes: parsed.engineGraph.nodes.length,\n        edges: parsed.engineGraph.edges.length,\n      }\n    : { nodes: 0, edges: 0 };\n\n  const renderGraph = () => {\n    if (!containerRef.current) {\n      return;\n    }\n\n    if (!parsed.ok) {\n      if (errorType === \"json\") {\n        setError(error ?? \"JSON parse error.\");\n      } else if (errorType === \"schema\") {\n        setError(error ?? \"Schema validation failed.\");\n      } else {\n        setError(\"Invalid JSON or schema validation failed.\");\n      }\n      return;\n    }\n\n    setError(null);\n\n    if (parsed.semantic.length > 0) {\n      const missing = parsed.semantic.find((issue) => issue.type === \"edge-missing-node\");\n      if (missing && missing.type === \"edge-missing-node\") {\n        setError(\n          `Edge ${missing.edge.from} â†’ ${missing.edge.to} references missing node \"${missing.missing}\".`,\n        );\n        return;\n      }\n    }\n\n    if (cy) {\n      cy.destroy();\n    }\n\n    const elements = toCytoscape(parsed.engineGraph);\n    const nodeIds = new Set(elements.nodes.map((node) => node.data.id));\n    const filteredEdges = elements.edges.filter((edge) => {\n      const source = edge.data.source;\n      const target = edge.data.target;\n      return Boolean(source) && Boolean(target) && nodeIds.has(source) && nodeIds.has(target);\n    });\n    if (filteredEdges.length !== elements.edges.length) {\n      setError(\"Some edges reference missing or empty node ids. Fix them before rendering.\");\n      return;\n    }\n    const nextCy = cytoscape({\n      container: containerRef.current,\n      elements: [...elements.nodes, ...filteredEdges],\n      style: styles,\n      layout: {\n        name: \"breadthfirst\",\n        directed: true,\n        padding: 24,\n      },\n    });\n\n    const direction = parsed.graph.layout?.direction ?? \"LR\";\n    nextCy.ready(() => applyLayoutDirection(nextCy, direction));\n\n    setCy(nextCy);\n  };\n\n  const exportImage = () => {\n    if (!cy) {\n      setError(\"Render a graph before exporting.\");\n      return;\n    }\n\n    const bgColor = theme === 'dark' ? '#0f172a' : '#ffffff';\n    const png = cy.png({ full: true, bg: bgColor });\n    if (downloadRef.current) {\n      downloadRef.current.href = png;\n      downloadRef.current.download = \"jsonflow-graph.png\";\n      downloadRef.current.click();\n    }\n  };\n\n  useEffect(() => {\n    const handler = () => renderGraph();\n    window.addEventListener(\"jsonflow:render\", handler);\n    return () => window.removeEventListener(\"jsonflow:render\", handler);\n  }, [parsed.ok, raw, error, errorType]);\n\n  return (\n    <main className=\"grid w-full gap-6 px-6 py-8 md:grid-cols-2\">\n      <a ref={downloadRef} className=\"hidden\" />\n      <EditorInterface\n        value={raw}\n        status={status}\n        errorMessage={error}\n        semanticIssues={parsed.ok ? parsed.semantic : undefined}\n        onChange={setRaw}\n        onRender={renderGraph}\n      />\n      <VisualInterface\n        onExport={exportImage}\n        canExport={Boolean(cy)}\n        stats={stats}\n        isCyclic={parsed.ok ? parsed.meta.isCyclic : undefined}\n        semanticIssues={parsed.ok ? parsed.semantic : undefined}\n        containerRef={containerRef}\n      />\n    </main>\n  );\n}\n"],"names":[],"mappings":"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"}}]
}